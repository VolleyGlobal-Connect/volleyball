name: Frontend Deployment

on:
    push:
        branches:
            - "**"
    pull_request:

jobs:
    deploy:
        runs-on: "ubuntu-latest"
        if: github.actor != 'DeepeshKalura'
        
        steps:
            - name: Install pnpm global system
              uses: pnpm/action-setup@v4
              with:
                version: 10.26.2
        
            - name: Checkout Code
              uses: actions/checkout@v4
            
            - name: Install Vercel CLI
              run: npm install --global vercel@latest
            
            - name: Pull Vercel Environment Information
              run: vercel pull --yes --environment=preview --token=${{ secrets.VERCEL_TOKEN }}
              env:
                VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }}
                VERCEL_PROJECT_ID: ${{ secrets.VERCEL_PROJECT_ID }}

            
            - name: Build Project Artifacts
              run: vercel build --token=${{ secrets.VERCEL_TOKEN }}
              env:
                VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }}
                VERCEL_PROJECT_ID: ${{ secrets.VERCEL_PROJECT_ID }}

            - name: Deploy to Vercel (Production)
              if: github.ref == 'refs/heads/main'
              id: deploy-production
              run: |
               DEPLOYMENT_URL=$(vercel deploy --prebuilt --prod --token=${{ secrets.VERCEL_TOKEN }} 2>&1 | grep -oP 'https://[^\s]+' | tail -1)
               echo "url=$DEPLOYMENT_URL" >> $GITHUB_OUTPUT
               echo "### ðŸš€ Production Deployment Successful!" >> $GITHUB_STEP_SUMMARY
               echo "" >> $GITHUB_STEP_SUMMARY
               echo "**Deployment URL:** $DEPLOYMENT_URL" >> $GITHUB_STEP_SUMMARY
               echo "" >> $GITHUB_STEP_SUMMARY
               echo "Branch: \`${{ github.ref_name }}\`" >> $GITHUB_STEP_SUMMARY
               echo "Commit: \`${{ github.sha }}\`" >> $GITHUB_STEP_SUMMARY
               env:
               VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }}
               VERCEL_PROJECT_ID: ${{ secrets.VERCEL_PROJECT_ID }}                


            - name: Deploy to Vercel (Preview)
              if: github.ref != 'refs/heads/main' || github.event_name == 'pull_request'
              id: deploy-preview
              run: |
                DEPLOYMENT_URL=$(vercel deploy --prebuilt --token=${{ secrets.VERCEL_TOKEN }} 2>&1 | grep -oP 'https://[^\s]+' | tail -1)
                echo "url=$DEPLOYMENT_URL" >> $GITHUB_OUTPUT
                echo "### ðŸ” Preview Deployment Successful!" >> $GITHUB_STEP_SUMMARY
                echo "" >> $GITHUB_STEP_SUMMARY
                echo "**Deployment URL:** $DEPLOYMENT_URL" >> $GITHUB_STEP_SUMMARY
                echo "" >> $GITHUB_STEP_SUMMARY
                echo "Branch: \`${{ github.ref_name }}\`" >> $GITHUB_STEP_SUMMARY
                echo "Commit: \`${{ github.sha }}\`" >> $GITHUB_STEP_SUMMARY
                env:
                VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }}
                VERCEL_PROJECT_ID: ${{ secrets.VERCEL_PROJECT_ID }}  

            - name: Display Deployment URL
              run: |
                if [ "${{ github.ref }}" == "refs/heads/main" ] || [ "${{ github.ref }}" == "refs/heads/master" ]; then
                    echo "Production Deployment URL: ${{ steps.deploy-production.outputs.url }}"
                else
                    echo "Preview Deployment URL: ${{ steps.deploy-preview.outputs.url }}"
                fi  